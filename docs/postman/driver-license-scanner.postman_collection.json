{
  "info": {
    "name": "Driver License Scanner",
    "_postman_id": "0f3b1e8e-0000-4d5a-9000-000000000000",
    "description": "Import this collection into Postman and run the requests or use the Collection Runner.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrlWeb",
      "value": "http://localhost:3000"
    },
    {
      "key": "baseUrlApi",
      "value": "http://localhost:8080"
    },
    {
      "key": "baseUrlOcr",
      "value": "http://localhost:8000"
    }
  ],
  "item": [
    {
      "name": "Health Checks",
      "item": [
        {
          "name": "Web - Root",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrlWeb}}/",
              "host": [
                "{{baseUrlWeb}}"
              ],
              "path": [
                ""
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "// Basic smoke check: response body should not be empty",
                  "pm.test('Body is not empty', function () {",
                  "  pm.expect(pm.response.text().length).to.be.above(0);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "API - Actuator Health",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrlApi}}/actuator/health",
              "host": [
                "{{baseUrlApi}}"
              ],
              "path": [
                "actuator",
                "health"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "// Try to parse JSON safely and check for a health status",
                  "var body = null;",
                  "try { body = pm.response.json(); } catch (e) { body = null; }",
                  "if (body && body.status) {",
                  "  pm.test('Health status is UP or ok', function() {",
                  "    pm.expect(['UP','OK','ok','up']).to.include(String(body.status));",
                  "  });",
                  "} else {",
                  "  pm.test('Response contains JSON body with a status field', function() {",
                  "    pm.expect(body).to.not.equal(null);",
                  "  });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "OCR Worker - /health",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrlOcr}}/health",
              "host": [
                "{{baseUrlOcr}}"
              ],
              "path": [
                "health"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "var body = null;",
                  "try { body = pm.response.json(); } catch (e) { body = null; }",
                  "if (body && body.status) {",
                  "  pm.test('Worker health status is ok or UP', function() {",
                  "    pm.expect(['ok','OK','up','UP']).to.include(String(body.status));",
                  "  });",
                  "} else {",
                  "  pm.test('Response should contain JSON body', function() {",
                  "    pm.expect(body).to.not.equal(null);",
                  "  });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Scan",
      "item": [
        {
          "name": "API - License Scan (worker up)",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "image",
                  "type": "file"
                }
              ]
            },
            "url": {
              "raw": "{{baseUrlApi}}/license/scan",
              "host": [
                "{{baseUrlApi}}"
              ],
              "path": [
                "license",
                "scan"
              ]
            },
            "description": "Use when OCR worker is running. Expect 200 with stub response (T12 not wired yet)."
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "API - License Scan (worker down)",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "image",
                  "type": "file"
                }
              ]
            },
            "url": {
              "raw": "{{baseUrlApi}}/license/scan",
              "host": [
                "{{baseUrlApi}}"
              ],
              "path": [
                "license",
                "scan"
              ]
            },
            "description": "Stop OCR worker before running. Expect 504 OCR_TIMEOUT."
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 504', function () {",
                  "  pm.response.to.have.status(504);",
                  "});",
                  "var body = {};",
                  "try { body = pm.response.json(); } catch (e) { body = {}; }",
                  "pm.test('Error code is OCR_TIMEOUT', function () {",
                  "  pm.expect(body.error && body.error.code).to.eql('OCR_TIMEOUT');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "API - License Scan (bad OCR URL)",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "image",
                  "type": "file"
                }
              ]
            },
            "url": {
              "raw": "{{baseUrlApi}}/license/scan",
              "host": [
                "{{baseUrlApi}}"
              ],
              "path": [
                "license",
                "scan"
              ]
            },
            "description": "Start API with OCR_WORKER_URL set to an invalid host. Expect 502 OCR_FAILED."
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 502', function () {",
                  "  pm.response.to.have.status(502);",
                  "});",
                  "var body = {};",
                  "try { body = pm.response.json(); } catch (e) { body = {}; }",
                  "pm.test('Error code is OCR_FAILED', function () {",
                  "  pm.expect(body.error && body.error.code).to.eql('OCR_FAILED');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "OCR Worker",
      "item": [
        {
          "name": "OCR - Scan",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "image",
                  "type": "file"
                }
              ]
            },
            "url": {
              "raw": "{{baseUrlOcr}}/ocr",
              "host": [
                "{{baseUrlOcr}}"
              ],
              "path": [
                "ocr"
              ]
            }
          },
          "response": []
        }
      ]
    }
  ]
}